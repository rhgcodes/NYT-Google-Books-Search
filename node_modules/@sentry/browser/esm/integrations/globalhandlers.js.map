{"version":3,"file":"globalhandlers.js","sourceRoot":"","sources":["../../src/integrations/globalhandlers.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCurrentHub } from '@sentry/core';\nimport { Integration, SentryEvent } from '@sentry/types';\nimport { logger } from '@sentry/utils/logger';\nimport { addExceptionTypeValue, eventFromStacktrace } from '../parsers';\nimport {\n  installGlobalHandler,\n  installGlobalUnhandledRejectionHandler,\n  StackTrace as TraceKitStackTrace,\n  subscribe,\n} from '../tracekit';\nimport { shouldIgnoreOnError } from './helpers';\n\n/** JSDoc */\ninterface GlobalHandlersIntegrations {\n  onerror: boolean;\n  onunhandledrejection: boolean;\n}\n\n/** Global handlers */\nexport class GlobalHandlers implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public name: string = GlobalHandlers.id;\n\n  /**\n   * @inheritDoc\n   */\n  public static id: string = 'GlobalHandlers';\n\n  /** JSDoc */\n  private readonly options: GlobalHandlersIntegrations;\n\n  /** JSDoc */\n  public constructor(options?: GlobalHandlersIntegrations) {\n    this.options = {\n      onerror: true,\n      onunhandledrejection: true,\n      ...options,\n    };\n  }\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(): void {\n    subscribe((stack: TraceKitStackTrace, _: boolean, error: Error) => {\n      // TODO: use stack.context to get a valuable information from TraceKit, eg.\n      // [\n      //   0: \"  })\"\n      //   1: \"\"\n      //   2: \"  function foo () {\"\n      //   3: \"    Sentry.captureException('some error')\"\n      //   4: \"    Sentry.captureMessage('some message')\"\n      //   5: \"    throw 'foo'\"\n      //   6: \"  }\"\n      //   7: \"\"\n      //   8: \"  function bar () {\"\n      //   9: \"    foo();\"\n      //   10: \"  }\"\n      // ]\n      if (shouldIgnoreOnError()) {\n        return;\n      }\n      const self = getCurrentHub().getIntegration(GlobalHandlers);\n      if (self) {\n        getCurrentHub().captureEvent(self.eventFromGlobalHandler(stack), { originalException: error, data: { stack } });\n      }\n    });\n\n    if (this.options.onerror) {\n      logger.log('Global Handler attached: onerror');\n      installGlobalHandler();\n    }\n\n    if (this.options.onunhandledrejection) {\n      logger.log('Global Handler attached: onunhandledrejection');\n      installGlobalUnhandledRejectionHandler();\n    }\n  }\n\n  /**\n   * This function creates an SentryEvent from an TraceKitStackTrace.\n   *\n   * @param stacktrace TraceKitStackTrace to be converted to an SentryEvent.\n   */\n  private eventFromGlobalHandler(stacktrace: TraceKitStackTrace): SentryEvent {\n    const event = eventFromStacktrace(stacktrace);\n\n    const data: { [key: string]: string } = {\n      mode: stacktrace.mode,\n    };\n\n    if (stacktrace.message) {\n      data.message = stacktrace.message;\n    }\n\n    if (stacktrace.name) {\n      data.name = stacktrace.name;\n    }\n\n    const newEvent: SentryEvent = {\n      ...event,\n      exception: {\n        ...event.exception,\n        mechanism: {\n          data,\n          handled: false,\n          type: stacktrace.mechanism,\n        },\n      },\n    };\n\n    const fallbackValue = typeof stacktrace.original !== 'undefined' ? `${stacktrace.original}` : '';\n    const fallbackType = stacktrace.mechanism === 'onunhandledrejection' ? 'UnhandledRejection' : 'Error';\n\n    // This makes sure we have type/value in every exception\n    addExceptionTypeValue(newEvent, fallbackValue, fallbackType);\n\n    return newEvent;\n  }\n}\n"]}